# FFmpeg самый простой гайд по кодированию

Актуальность 2022 март

Краткий гайд по тому как сконвертировать видео, что лучше выбрать, без лишней информации

## Примечение, то что актуально для всех кодеков

Если вывод идёт в контейнер MP4, добавляйте в конец командной строки `-movflags +faststart`. Это позволит смотреть файл до полной загрузки.

При использовании 10 бит, видео будет сжиматься лучше, даже если исходный был в 8 бит. Но немного дольше кодируется видео, и может не поддерживать ускорение. Это из-за того, что при сжатии значения округляются, а для 10 бит будет меньше ошибки. Он включается параметром `-pix_fmt yuv420p10le`, а 8 бит это `-pix_fmt yuv420p`.

Перед `-i` можно всегда писать `-hwaccel auto`, чтобы исходное видео декодировалось на видеокарте, хуже не станет. Возможные варианты глянуть `ffmpeg -hwaccels`

**Лайфхак:** Для записи рабочего стола можно выбрать в OBS `yuv444p` `yuv444p10le` что значительно повысит качество видео при таком же размере.

## Режимы кодирования

Есть два режима которые следует использовать: CRF или с указанием битрейта.

Первый когда вам нужно получить видео которое на глаз выглядит нормально для своего размера. Чем выше значение тем ниже качество и меньше файл.

Примерная таблица по подбору значений:

- 18-22 для 480p/576p Standard Definition
- 19-23 для 720p High Definition
- 20-24 для 1080p Full High Definition
- 22-28 для 2160p 4K Ultra High Definition

[источник](https://handbrake.fr/docs/en/latest/workflow/adjust-quality.html)

Второй когда есть какое-то жёсткое ограничение по размеру. 

Например нужно получить файл не больше 10 мегабайт или 10000 килобайт.

Для этого переводите килобайты в килобиты и делите на количество секунд в видео: 10000 * 8 / 35 получается 2340 килобит в секунду (ещё бы учитывать битрейт аудио) `-b:v 2340k`, или такая скорость интернета потребуется для просмотра в прямом эфире.

Вот хороший калькулятор: [ссылка](https://web.archive.org/web/20210401103230/http://www.3ivx.com/support/calculator/index.html)

**CQ и остальные выглядят хуже потому что предназначены для другого и поэтому не рекомендуются!**

## H.264

Самый простой и распространённый кодек. Поддерживается абсолютно везде. До сих пор актуален особенно для разрешений ниже 1080p или когда нужна высокая скорость кодирования. Новые кодеки сделают видео с более худшим качеством, если выбрать аналогичный по скорости пресет. Поддержку 10 бит в железо не завезли. Кодировать в два потока не нужно, это устаревшая информация. Это не даст больше качества, а кодировщик научился подбирать размер с первого раза.

Не используйте пресеты медленее чем slow, (slower, veryslow, placebo) в них нет смысла.

https://trac.ffmpeg.org/wiki/Encode/H.264

CRF:

```powershell
ffmpeg -hwaccel auto -i "1.mkv" -c:v libx264 -crf 30 -preset slow "out.mkv"
```

Битрейт:

```powershell
ffmpeg -hwaccel auto -i "1.mkv" -c:v libx264 -b:v 5000k -preset slow "out.mkv"
```

## H.265

Дальнейшее развитие H.264, но не приобрёл популярности и поддержки в браузерах из-за непонятных патентов. Если вам не нужно показывать видео через браузер, это лучший вариант. Информация выше подходит, только можно использовать 10 бит, из-за поддержки большинством устройств

https://trac.ffmpeg.org/wiki/Encode/H.265

CRF:

```powershell
ffmpeg -hwaccel auto -i "1.mkv" -c:v libx265 -crf 30 -preset medium -pix_fmt yuv420p10le "out.mkv"
```

Битрейт:

```powershell
ffmpeg -hwaccel auto -i "1.mkv" -c:v libx265 -b:v 5000k -preset medium -pix_fmt yuv420p10le "out.mkv"
```

## VP9

Полностью свободная и бесплатная замена H.265 но не имеет нормального кодировщика. На практике показывает результаты чуть лучше чем у x264, но хуже x265. Сложнее в настройке и требует значительно больше времени на сжатие. Используйте только если хотите получить видео для браузера, и оно никак не влезает в нужный размер, в приемлемом качестве в H.264. C 10 бит тоже беда.

**Примечание:** нужно всегда кодировать в два прохода для лучшего качества, первый будет практически мгновенным, так что больше времени не займёт.

Ниже написаны наиболее оптимальные настройки, включены все штуки улучшующие качество, за разумное время. `-cpu-used` это аналог `-preset`, меньше число - медленее. Оптимально 3 или 4, **значение больше сделает первый проход очень медленным.**

https://trac.ffmpeg.org/wiki/Encode/VP9

https://www.reddit.com/r/AV1/comments/k7colv/encoder_tuning_part_1_tuning_libvpxvp9_be_more/

CRF:

```powershell
ffmpeg -hwaccel auto -i "1.mkv" -c:v libvpx-vp9 -quality good -cpu-used 4 -crf 30 -b:v 0 -pix_fmt yuv420p -lag-in-frames 25 -tile-columns 2 -tile-rows 0 -threads 8 -row-mt 1 -auto-alt-ref 1 -enable-tpl 1 -pass 1 -an -f null -

ffmpeg -hwaccel auto -i "1.mkv" -c:v libvpx-vp9 -quality good -cpu-used 4 -crf 30 -b:v 0 -pix_fmt yuv420p -lag-in-frames 25 -tile-columns 2 -tile-rows 0 -threads 8 -row-mt 1 -auto-alt-ref 1 -enable-tpl 1 -pass 2 "out.webm"
```

Битрейт:

```powershell
ffmpeg -hwaccel auto -i "1.mkv" -c:v libvpx-vp9 -quality good -cpu-used 4 -b:v 5000k -pix_fmt yuv420p -lag-in-frames 25 -tile-columns 2 -tile-rows 0 -threads 8 -row-mt 1 -auto-alt-ref 1 -enable-tpl 1 -pass 1 -an -f null -

ffmpeg -hwaccel auto -i "1.mkv" -c:v libvpx-vp9 -quality good -cpu-used 4 -b:v 5000k -pix_fmt yuv420p -lag-in-frames 25 -tile-columns 2 -tile-rows 0 -threads 8 -row-mt 1 -auto-alt-ref 1 -enable-tpl 1 -pass 2 "out.webm"
```

## AV1

До сих пор сырой кодек который толком никуда не годится, хотя и сжимает лучше всех. 

## Аудио

### Opus

Лучший возможный вариант из доступных, поддерживается везде, даже в MP4. Оптимальный битрейт 160k, по тестам звучит лучше чем 320k mp3, на самом деле это не CBR а VBR, так что размер может изменятся для лучшего качества.

https://wiki.hydrogenaud.io/index.php?title=Opus

Есть хитрость позволяющая немного улучшить качество, использовать другую библиотеку для преобразования, если не сработает уберите фильтр:

```powershell
-c:a libopus -b:a 160k -filter:a "aresample=48000:resampler=soxr:precision=33"
```

### AAC

Если зачем-то нужен AAC, то его нужно кодировать через FDK AAC который по умолчанию не прилагается в FFmpeg. Ищите сборки nonfree. Чем меньше VBR тем сильнее сжатие, 5 оптимальнее всего. Слишком агрессивный фильтр по умолчанию, который я рекомедную отключить. Не поддерживается в WEBM.

https://trac.ffmpeg.org/wiki/Encode/AAC

https://wiki.hydrogenaud.io/index.php?title=Fraunhofer_FDK_AAC

```powershell
-c:a libfdk_aac -vbr 5 -cutoff 20000
```

### FLAC

Отличный вариант для нормальных людей, не поддерживается в WEBM.

```powershell
-c:a flac -sample_fmt s16 -ar 41000 -compression_level 12
```

## Аппаратное кодирование

Слишком сложная тема в которой огромное количество вариантов, зависящих от модели видеокарты, драйверов и остальных параметров. Самые лучшие варианты кодируют с качеством около x264 medium, но в десятки раз быстрее. У Nvidia есть режим видео без потерь, которые получаются даже меньше чем через программные решения. В последних встройках интела можно закодировать VP9.
